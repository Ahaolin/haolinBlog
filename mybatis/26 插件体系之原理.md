# ç²¾å°½ MyBatis æºç åˆ†æ â€”â€” æ’ä»¶ä½“ç³»ï¼ˆä¸€ï¼‰ä¹‹åŸç†

## 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« MyBatis çš„æ’ä»¶æ¨¡å—ï¼Œå¯¹åº” `plugin` åŒ…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![`scripting` åŒ…](http://ahaolin-public-img.oss-cn-hangzhou.aliyuncs.com/img/202202111116535.png)](http://static.iocoder.cn/images/MyBatis/2020_03_18/01.png)`scripting` åŒ…

åœ¨ [ã€Šç²¾å°½ MyBatis æºç è§£æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹](http://svip.iocoder.cn/MyBatis/intro) ä¸­ï¼Œç®€å•ä»‹ç»äº†è¿™ä¸ªæ¨¡å—å¦‚ä¸‹ï¼š

> Mybatis è‡ªèº«çš„åŠŸèƒ½è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯å¹¶ä¸èƒ½å®Œç¾åˆ‡åˆæ‰€æœ‰çš„åº”ç”¨åœºæ™¯ï¼Œå› æ­¤ MyBatis æä¾›äº†æ’ä»¶æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶çš„æ–¹å¼å¯¹ MyBatis è¿›è¡Œæ‰©å±•ã€‚ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ä¹Ÿå¯ä»¥æ”¹å˜ Mybatis çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¦æˆª SQL è¯­å¥å¹¶å¯¹å…¶è¿›è¡Œé‡å†™ã€‚
>
> ç”±äºç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ä¼šå½±å“ MyBatis çš„æ ¸å¿ƒè¡Œä¸ºï¼Œåœ¨ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶ä¹‹å‰ï¼Œå¼€å‘äººå‘˜éœ€è¦äº†è§£ MyBatis å†…éƒ¨çš„åŸç†ï¼Œè¿™æ ·æ‰èƒ½ç¼–å†™å‡ºå®‰å…¨ã€é«˜æ•ˆçš„æ’ä»¶ã€‚

- æ€»çš„æ¥è¯´ï¼ŒMyBatis çš„æ’ä»¶ï¼Œè¿˜æ˜¯åŸºäº**åŠ¨æ€ä»£ç†**æ¥å®ç°ã€‚æ‰€ä»¥ï¼ŒğŸ˜ˆ èƒ–å‹æœ‰æ²¡å‘ç°ï¼ŒåŠ¨æ€ä»£ç†ï¼Œæ— å¤„ä¸åœ¨ã€‚å˜¿å˜¿ã€‚
- å¦å¤–ï¼Œèƒ–å‹å…ˆçœ‹çœ‹ [ã€ŠMyBatis å®˜æ–¹æ–‡æ¡£ â€”â€” æ’ä»¶ã€‹](http://www.mybatis.org/mybatis-3/zh/configuration.html#plugins) æ–‡æ¡£ï¼Œå¯¹ MyBatis æ’ä»¶çš„æ¦‚å¿µå’Œé…ç½®ï¼Œå†æœ‰ä¸€ä¸ªäº†è§£ã€‚

æœ¬æ–‡æ¶‰åŠçš„ç±»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š[![ç±»å›¾](http://ahaolin-public-img.oss-cn-hangzhou.aliyuncs.com/img/202202111116554.png)](http://static.iocoder.cn/images/MyBatis/2020_03_18/02.png)ç±»å›¾

ä¸‹é¢ï¼Œæˆ‘ä»¬é€ä¸ªç±»æ¥ç…ç…ã€‚

## 2. Interceptor

`org.apache.ibatis.plugin.Interceptor` ï¼Œæ‹¦æˆªå™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Interceptor.java

public interface Interceptor {

    /**
     * æ‹¦æˆªæ–¹æ³•
     *
     * @param invocation è°ƒç”¨ä¿¡æ¯
     * @return è°ƒç”¨ç»“æœ
     * @throws Throwable è‹¥å‘ç”Ÿå¼‚å¸¸
     */
    Object intercept(Invocation invocation) throws Throwable;

    /**
     * åº”ç”¨æ’ä»¶ã€‚å¦‚åº”ç”¨æˆåŠŸï¼Œåˆ™ä¼šåˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡
     *
     * @param target ç›®æ ‡å¯¹è±¡
     * @return åº”ç”¨çš„ç»“æœå¯¹è±¡ï¼Œå¯ä»¥æ˜¯ä»£ç†å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ target å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ã€‚å…·ä½“çš„ï¼Œçœ‹ä»£ç å®ç°
     */
    Object plugin(Object target);

    /**
     * è®¾ç½®æ‹¦æˆªå™¨å±æ€§
     *
     * @param properties å±æ€§
     */
    void setProperties(Properties properties);

}
```

- å…³äºä¸‰ä¸ªæ–¹æ³•ï¼Œèƒ–å‹çœ‹çœ‹ä»£ç æ³¨é‡Šã€‚

### 2.1 ç¤ºä¾‹

æˆ‘ä»¬æ¥çœ‹çœ‹ `org.apache.ibatis.plugin.PluginTest` ï¼Œæä¾›äº† AlwaysMapPlugin ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Intercepts({
        @Signature(type = Map.class, method = "get", args = {Object.class})}) // <1>
public static class AlwaysMapPlugin implements Interceptor {

    @Override // <4>
    public Object intercept(Invocation invocation) throws Throwable {
        return "Always";
    }

    @Override // <2>
    public Object plugin(Object target) {
        return Plugin.wrap(target, this);
    }

    @Override // <3>
    public void setProperties(Properties properties) {
    }

}
```

- `<1>` å¤„ï¼Œé€šè¿‡ `@Intercepts` å’Œ `@Signature` æ³¨è§£ï¼Œå®šä¹‰äº†éœ€è¦æ‹¦æˆªçš„æ–¹æ³•ä¸º Map ç±»å‹ã€æ–¹æ³•ä¸º `"get"` æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°ä¸º `Object.class` ã€‚è¯¦ç»†è§£æï¼Œè§ TODOã€‚
- `<2>` å¤„ï¼Œåœ¨å®ç°æ–¹æ³• `#plugin(Object target)` æ–¹æ³•å†…éƒ¨ï¼Œä»–è°ƒç”¨ `Plugin#wrap(Object target, Interceptor interceptor)` æ–¹æ³•ï¼Œæ‰§è¡Œä»£ç†å¯¹è±¡çš„åˆ›å»ºã€‚è¯¦ç»†è§£æï¼Œè§ TODOã€‚
- `<3>` å¤„ï¼Œåœ¨å®ç°æ–¹æ³• `#setProperties(Properties properties)` æ–¹æ³•å†…éƒ¨ï¼Œæš‚æœªåšä»»ä½•å®ç°ã€‚æ­¤å¤„å¯ä»¥å®ç°ï¼Œè‹¥ AlwaysMapPlugin æœ‰å±æ€§ï¼Œå¯ä»¥ä» `properties` è·å–ä¸€äº›éœ€è¦çš„å±æ€§å€¼ã€‚
- `<4>` å¤„ï¼Œåœ¨å®ç°æ–¹æ³• `#intercept(Invocation invocation)` æ–¹æ³•ï¼Œç›´æ¥è¿”å› `"Always"` å­—ç¬¦ä¸²ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰€æœ‰çš„ `target` ç±»å‹ä¸º Map ç±»å‹ï¼Œå¹¶ä¸”è°ƒç”¨ `Map#get(Object)` æ–¹æ³•æ—¶ï¼Œè¿”å›çš„éƒ½æ˜¯ `"Always"` ã€‚

è¿™ä¸ªç¤ºä¾‹ï¼Œèƒ–å‹å¯ä»¥è·‘ä¸‹ PluginTest å•å…ƒæµ‹è¯•é‡Œçš„æ–¹æ³•ï¼Œå¯ä»¥æ›´åŠ å¥½ç†è§£ã€‚

### 2.2 Invocation

`org.apache.ibatis.plugin.Invocation` ï¼Œæ–¹æ³•è°ƒç”¨ä¿¡æ¯ï¼Œä½œä¸º `Interceptor#intercept(Invocation invocation)` çš„æ–¹æ³•å‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Invocation.java

public class Invocation {

    /**
     * ç›®æ ‡å¯¹è±¡
     */
    private final Object target;
    /**
     * æ–¹æ³•å¯¹è±¡
     */
    private final Method method;
    /**
     * æ–¹æ³•å‚æ•°æ•°ç»„
     */
    private final Object[] args;

    public Invocation(Object target, Method method, Object[] args) {
        this.target = target;
        this.method = method;
        this.args = args;
    }

    public Object getTarget() {
        return target;
    }

    public Method getMethod() {
        return method;
    }

    public Object[] getArgs() {
        return args;
    }

    /**
     * è°ƒç”¨æ–¹æ³•
     *
     * @return è°ƒç”¨ç»“æœ
     */
    public Object proceed() throws InvocationTargetException, IllegalAccessException {
        return method.invoke(target, args);
    }

}
```

## 3. InterceptorChain

`org.apache.ibatis.plugin.InterceptorChain` ï¼Œæ‹¦æˆªå™¨ Interceptor é“¾ã€‚

### 3.1 æ„é€ æ–¹æ³•

```java
// InterceptorChain.java

/**
 * æ‹¦æˆªå™¨æ•°ç»„
 */
private final List<Interceptor> interceptors = new ArrayList<>();
```

### 3.2 addInterceptor

`#addInterceptor(Interceptor interceptor)` æ–¹æ³•ï¼Œæ·»åŠ æ‹¦æˆªå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// InterceptorChain.java

public void addInterceptor(Interceptor interceptor) {
    interceptors.add(interceptor);
}
```

------

è¯¥æ–¹æ³•åœ¨ Configuration çš„ `#pluginElement(XNode parent)` æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
// XMLConfigBuilder.java

/**
 * è§£æ <plugins /> æ ‡ç­¾ï¼Œæ·»åŠ åˆ° {@link Configuration#interceptorChain} ä¸­
 *
 * @param parent èŠ‚ç‚¹
 * @throws Exception å‘ç”Ÿå¼‚å¸¸æ—¶
 */
private void pluginElement(XNode parent) throws Exception {
    if (parent != null) {
        // éå† <plugins /> æ ‡ç­¾
        for (XNode child : parent.getChildren()) {
            String interceptor = child.getStringAttribute("interceptor");
            Properties properties = child.getChildrenAsProperties();
            // <1> åˆ›å»º Interceptor å¯¹è±¡ï¼Œå¹¶è®¾ç½®å±æ€§
            Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();
            interceptorInstance.setProperties(properties);
            // æ·»åŠ åˆ° configuration ä¸­
            configuration.addInterceptor(interceptorInstance);
        }
    }
}
```

- `<1>` å¤„ï¼Œåˆ›å»º Interceptor å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ `Interceptor#setProperties(properties)` æ–¹æ³•ï¼Œè®¾ç½®æ‹¦æˆªå™¨çš„å±æ€§ã€‚

- `<2>` å¤„ï¼Œè°ƒç”¨ `Configuration#addInterceptor(interceptorInstance)` æ–¹æ³•ï¼Œæ·»åŠ åˆ° `Configuration.interceptorChain` ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // Configuration.java
  
  /**
   * æ‹¦æˆªå™¨é“¾
   */
  protected final InterceptorChain interceptorChain = new InterceptorChain();
  
  public void addInterceptor(Interceptor interceptor) {
      interceptorChain.addInterceptor(interceptor);
  }
  ```

### 3.3 pluginAll

`#pluginAll(Object target)` æ–¹æ³•ï¼Œåº”ç”¨æ‰€æœ‰æ‹¦æˆªå™¨åˆ°æŒ‡å®šç›®æ ‡å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// InterceptorChain.java

public Object pluginAll(Object target) {
    for (Interceptor interceptor : interceptors) {
        target = interceptor.plugin(target);
    }
    return target;
}
```

------

è¯¥æ–¹æ³•è¢« Configuration çš„å¦‚ä¸‹å››å¤„æ–¹æ³•ä¸­è°ƒç”¨ï¼š![è°ƒç”¨å¤„](http://static.iocoder.cn/images/MyBatis/2020_03_18/03.png)

- ä¸€å…±å¯ä»¥æœ‰å››ç§ç›®æ ‡å¯¹è±¡ç±»å‹å¯ä»¥è¢«æ‹¦æˆªï¼š
  1. `Executor`ï¼›
  2. `StatementHandler`ï¼›
  3. `ParameterHandler`ï¼›
  4. `ResultSetHandler `ã€‚

## 4. @Intercepts

`org.apache.ibatis.plugin.@Intercepts` ï¼Œæ‹¦æˆªå™¨æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Intercepts.java

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
public @interface Intercepts {

    /**
     * @return æ‹¦æˆªçš„æ–¹æ³•ç­¾åçš„æ•°ç»„
     */
    Signature[] value();

}
```

### 4.1 @Signature

`org.apache.ibatis.plugin.@Signature` ï¼Œæ–¹æ³•ç­¾åçš„æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Signature.java

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({})
public @interface Signature {

    /**
     * @return ç±»
     */
    Class<?> type();

    /**
     * @return æ–¹æ³•å
     */
    String method();

    /**
     * @return å‚æ•°ç±»å‹
     */
    Class<?>[] args();

}
```

## 5. Plugin

`org.apache.ibatis.plugin.Plugin` ï¼Œå®ç° `InvocationHandler `æ¥å£ï¼Œæ’ä»¶ç±»ï¼Œä¸€æ–¹é¢æä¾›åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦ä¸€æ–¹é¢å®ç°å¯¹æŒ‡å®šç±»çš„æŒ‡å®šæ–¹æ³•çš„æ‹¦æˆªå¤„ç†ã€‚

æ³¨æ„ï¼ŒPlugin æ˜¯ MyBatis æ’ä»¶ä½“ç³»çš„æ ¸å¿ƒç±»ã€‚

### 5.1 æ„é€ æ–¹æ³•

```java
// Plugin.java

/**
 * ç›®æ ‡å¯¹è±¡
 */
private final Object target;
/**
 * æ‹¦æˆªå™¨
 */
private final Interceptor interceptor;
/**
 * æ‹¦æˆªçš„æ–¹æ³•æ˜ å°„
 *
 * KEYï¼šç±»
 * VALUEï¼šæ–¹æ³•é›†åˆ
 */
private final Map<Class<?>, Set<Method>> signatureMap;

private Plugin(Object target, Interceptor interceptor, Map<Class<?>, Set<Method>> signatureMap) {
    this.target = target;
    this.interceptor = interceptor;
    this.signatureMap = signatureMap;
}
```

### 5.2 wrap

`#wrap(Object target, Interceptor interceptor)` **é™æ€**æ–¹æ³•ï¼Œåˆ›å»ºç›®æ ‡ç±»çš„ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// Plugin.java

public static Object wrap(Object target, Interceptor interceptor) {
    // <1> è·å¾—æ‹¦æˆªçš„æ–¹æ³•æ˜ å°„
    Map<Class<?>, Set<Method>> signatureMap = getSignatureMap(interceptor);
    // <2> è·å¾—ç›®æ ‡ç±»çš„ç±»å‹
    Class<?> type = target.getClass();
    // <2> è·å¾—ç›®æ ‡ç±»çš„æ¥å£é›†åˆ
    Class<?>[] interfaces = getAllInterfaces(type, signatureMap);
    // <3.1> è‹¥æœ‰æ¥å£ï¼Œåˆ™åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ JDK Proxy å¯¹è±¡
    if (interfaces.length > 0) {
        return Proxy.newProxyInstance(
                type.getClassLoader(),
                interfaces,
                new Plugin(target, interceptor, signatureMap)); // å› ä¸º Plugin å®ç°äº† InvocationHandler æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸º JDK åŠ¨æ€ä»£ç†çš„è°ƒç”¨å¤„ç†å™¨
    }
    // <3.2> å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›åŸå§‹çš„ç›®æ ‡å¯¹è±¡
    return target;
}
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `#getSignatureMap(Interceptor interceptor)` æ–¹æ³•ï¼Œè·å¾—æ‹¦æˆªçš„æ–¹æ³•æ˜ å°„ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // Plugin.java
  
  private static Map<Class<?>, Set<Method>> getSignatureMap(Interceptor interceptor) {
      Intercepts interceptsAnnotation = interceptor.getClass().getAnnotation(Intercepts.class);
      // issue #251
      if (interceptsAnnotation == null) {
          throw new PluginException("No @Intercepts annotation was found in interceptor " + interceptor.getClass().getName());
      }
      Signature[] sigs = interceptsAnnotation.value();
      Map<Class<?>, Set<Method>> signatureMap = new HashMap<>();
      for (Signature sig : sigs) {
          Set<Method> methods = signatureMap.computeIfAbsent(sig.type(), k -> new HashSet<>());
          try {
              Method method = sig.type().getMethod(sig.method(), sig.args());
              methods.add(method);
          } catch (NoSuchMethodException e) {
              throw new PluginException("Could not find method on " + sig.type() + " named " + sig.method() + ". Cause: " + e, e);
          }
      }
      return signatureMap;
  }
  ```

  - åŸºäº `@Intercepts` å’Œ `@Signature` æ³¨è§£ã€‚

- `<2>` å¤„ï¼Œè°ƒç”¨ `#getAllInterfaces(Class<?> type, Map<Class<?>, Set<Method>> signatureMap)` æ–¹æ³•ï¼Œè·å¾—ç›®æ ‡ç±»çš„æ¥å£é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // Plugin.java
  
  private static Class<?>[] getAllInterfaces(Class<?> type, Map<Class<?>, Set<Method>> signatureMap) {
      // æ¥å£çš„é›†åˆ
      Set<Class<?>> interfaces = new HashSet<>();
      // å¾ªç¯é€’å½’ type ç±»ï¼Œæœºå™¨çˆ¶ç±»
      while (type != null) {
          // éå†æ¥å£é›†åˆï¼Œè‹¥åœ¨ signatureMap ä¸­ï¼Œåˆ™æ·»åŠ åˆ° interfaces ä¸­
          for (Class<?> c : type.getInterfaces()) {
              if (signatureMap.containsKey(c)) {
                  interfaces.add(c);
              }
          }
          // è·å¾—çˆ¶ç±»
          type = type.getSuperclass();
      }
      // åˆ›å»ºæ¥å£çš„æ•°ç»„
      return interfaces.toArray(new Class<?>[interfaces.size()]);
  }
  ```

  - ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œ`@Signature` æ³¨è§£çš„ `type` å±æ€§ï¼Œå¿…é¡»æ˜¯**æ¥å£**ã€‚

- `<3.1>` å¤„ï¼Œ**æƒ…å†µä¸€**ï¼Œè‹¥æœ‰æ¥å£ï¼Œåˆ™åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ JDK Proxy å¯¹è±¡ã€‚

- `<3.2>` å¤„ï¼Œ**æƒ…å†µäºŒ**ï¼Œè‹¥æ— æ¥å£ï¼Œåˆ™è¿”å›åŸå§‹çš„ç›®æ ‡å¯¹è±¡ã€‚

### 5.3 invoke

```java
// Plugin.java

@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    try {
        // è·å¾—ç›®æ ‡æ–¹æ³•æ˜¯å¦è¢«æ‹¦æˆª
        Set<Method> methods = signatureMap.get(method.getDeclaringClass());
        if (methods != null && methods.contains(method)) {
            // å¦‚æœæ˜¯ï¼Œåˆ™æ‹¦æˆªå¤„ç†è¯¥æ–¹æ³•
            return interceptor.intercept(new Invocation(target, method, args));
        }
        // å¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨åŸæ–¹æ³•
        return method.invoke(target, args);
    } catch (Exception e) {
        throw ExceptionUtil.unwrapThrowable(e);
    }
}
```

- å…·ä½“ï¼Œè§ä»£ç æ³¨é‡Šã€‚ç®€å•~



## 6. æ€»ç»“

> è¯¥ç¯‡æ€»ç»“æºè‡ªï¼š
>
> - ç¥–å¤§ä¿Š [ã€ŠMybatis3.4.xæŠ€æœ¯å†…å¹•ï¼ˆåä¹ï¼‰ï¼šMybatisä¹‹pluginæ’ä»¶è®¾è®¡åŸç†ã€‹](https://my.oschina.net/zudajun/blog/738973)
> - ç”°å°æ³¢ [ã€ŠMyBatis æºç åˆ†æ - æ’ä»¶æœºåˆ¶ã€‹](https://www.tianxiaobo.com/2018/08/26/MyBatis-æºç åˆ†æ-æ’ä»¶æœºåˆ¶/)

###  6.1 æ’ä»¶æœºåˆ¶åŸç†

> ç¼–å†™æ’ä»¶æ—¶ï¼Œé™¤äº†éœ€è¦è®©æ’ä»¶ç±»å®ç° Interceptor æ¥å£ï¼Œè¿˜éœ€è¦é€šè¿‡æ³¨è§£æ ‡æ³¨è¯¥æ’ä»¶çš„æ‹¦æˆªç‚¹ã€‚æ‰€è°“æ‹¦æˆªç‚¹æŒ‡çš„æ˜¯æ’ä»¶æ‰€èƒ½æ‹¦æˆªçš„æ–¹æ³•ï¼ŒMyBatis æ‰€å…è®¸æ‹¦æˆªçš„æ–¹æ³•å¦‚ä¸‹ï¼š
>
> - `Executor `(update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)
> - `ParameterHandler `(getParameterObject, setParameters)
> - `ResultSetHandler `(handleResultSets, handleOutputParameters)
> - `StatementHandler `(prepare, parameterize, batch, update, query)

å¦‚æœæˆ‘ä»¬æƒ³è¦æ‹¦æˆª Executor çš„ query æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·å®šä¹‰æ’ä»¶ã€‚

```java
 @Intercepts({
            @Signature(
                    type = Executor.class,	 // éœ€è¦æ‹¦æˆªçš„ç±» ï¼Œå¿…é¡»å­˜åœ¨æ¥å£  å› ä¸ºæ˜¯ jdkåŠ¨æ€ä»£ç†
                    method = "query",	   // è°ƒç”¨æ¥å£ä¸­å­˜åœ¨çš„æ–¹æ³• è¿›è¡Œæ‹¦æˆª
                    args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
            )
    })
    public class ExamplePlugin implements Interceptor {
        // çœç•¥é€»è¾‘
    }
```

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€å°†æ’ä»¶é…ç½®åˆ°ç›¸å…³æ–‡ä»¶ä¸­ã€‚è¿™æ · MyBatis åœ¨å¯åŠ¨æ—¶å¯ä»¥åŠ è½½æ’ä»¶ï¼Œå¹¶ä¿å­˜æ’ä»¶å®ä¾‹åˆ°ç›¸å…³å¯¹è±¡ï¼ˆ`InterceptorChain`ï¼Œæ‹¦æˆªå™¨é“¾ï¼‰ä¸­ã€‚å¾…å‡†å¤‡å·¥ä½œåšå®Œåï¼ŒMyBatis å¤„äºå°±ç»ªçŠ¶æ€ã€‚æˆ‘ä»¬åœ¨æ‰§è¡Œ SQL æ—¶ï¼Œéœ€è¦å…ˆé€šè¿‡ `DefaultSqlSessionFactory `åˆ›å»º `SqlSession `ã€‚`Executor `å®ä¾‹ä¼šåœ¨åˆ›å»º `SqlSession `çš„è¿‡ç¨‹ä¸­è¢«åˆ›å»ºï¼Œ`Executor `å®ä¾‹åˆ›å»ºå®Œæ¯•åï¼ŒMyBatis ä¼šé€šè¿‡ **JDK åŠ¨æ€ä»£ç†**ä¸ºå®ä¾‹ç”Ÿæˆä»£ç†ç±»ã€‚è¿™æ ·ï¼Œæ’ä»¶é€»è¾‘å³å¯åœ¨ Executor ç›¸å…³æ–¹æ³•è¢«è°ƒç”¨å‰æ‰§è¡Œã€‚

```java
    @Test
    public void shouldNotInterceptToString() {
        Map map = new HashMap();
        map = (Map) new AlwaysMapPlugin().plugin(map);
        assertNotEquals("Always", map.toString());
        assertEquals("Always", map.get(null)); // æ°¸è¿œè¿”å› Always ,æ— è®ºkeyä¸ºå¤šå°‘
    }

  @Intercepts({
            @Signature(type = Map.class, method = "get", args = {Object.class})})
    public static class AlwaysMapPlugin implements Interceptor {
        @Override
        public Object intercept(Invocation invocation) throws Throwable {
            return "Always";
        }

        @Override
        public Object plugin(Object target) {
            return Plugin.wrap(target, this);
        }

        @Override
        public void setProperties(Properties properties) {
        }
    }
```

### 6.2 é€»è¾‘åˆ†æ

#### 6.2.1 æ’ä»¶é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <plugins>
		<plugin interceptor="com.mybatis3.interceptor.MyBatisInterceptor">
			<property name="value" value="100" />
		</plugin>
	</plugins>
</configuration>
```

è§£æé…ç½®æ–‡ä»¶ä¸­çš„æ’ä»¶,å¹¶ä¿å­˜è‡³[`Configuration.interceptorChain `](#3. InterceptorChain)ä¸­

```java
pluginElement(root.evalNode("plugins"));

 private void pluginElement(XNode parent) throws Exception {
    if (parent != null) {
      for (XNode child : parent.getChildren()) {
        String interceptor = child.getStringAttribute("interceptor");
        Properties properties = child.getChildrenAsProperties();
        Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();
        // è¿™é‡Œå±•ç¤ºäº†setProperties()æ–¹æ³•çš„è°ƒç”¨æ—¶æœº
        interceptorInstance.setProperties(properties);
        configuration.addInterceptor(interceptorInstance);
      }
    }
  }
```

#### 6.2.2 æ¤å…¥æ’ä»¶é€»è¾‘

è°ƒç”¨`InterceptorChain.pluginAll`å¯¹targetè¿›è¡Œå¢å¼ºã€‚

```java
// InterceptorChain.java
private final List<Interceptor> interceptors = new ArrayList<Interceptor>();

public Object pluginAll(Object target) {
        // éå†æ‹¦æˆªå™¨é›†åˆ
        for (Interceptor interceptor : interceptors) {
            // è°ƒç”¨æ‹¦æˆªå™¨çš„ plugin æ–¹æ³•æ¤å…¥ç›¸åº”çš„æ’ä»¶é€»è¾‘
            target = interceptor.plugin(target);
        }
        return target;
}
```

ä»¥ä¸‹æ˜¯æ‰§è¡Œ`InterceptorChain.pluginAll`æ–¹æ³•çš„4å¤„åœ°æ–¹ã€‚

![è°ƒç”¨å¤„](http://ahaolin-public-img.oss-cn-hangzhou.aliyuncs.com/img/202202141347444.png)

------

##### 6.2.2.1 Executoræ¤å…¥æ’ä»¶

> ä¸‹é¢ä»¥`Executor `ä¸ºä¾‹ï¼Œåˆ†æ MyBatis æ˜¯å¦‚ä½•ä¸º Executor å®ä¾‹æ¤å…¥æ’ä»¶é€»è¾‘çš„ã€‚

`Executor `å®ä¾‹æ˜¯åœ¨å¼€å¯ `SqlSession `æ—¶è¢«åˆ›å»ºçš„

```java
// -â˜†- DefaultSqlSessionFactory
public SqlSession openSession() {
    return openSessionFromDataSource(configuration.getDefaultExecutorType(), null, false);
}

private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
    Transaction tx = null;
    try {
        // çœç•¥éƒ¨åˆ†é€»è¾‘
        
        // åˆ›å»º Executor
        final Executor executor = configuration.newExecutor(tx, execType);
        return new DefaultSqlSession(configuration, executor, autoCommit);
    } 
    catch (Exception e) {...} 
    finally {...}
}
```

`Executor `çš„åˆ›å»ºè¿‡ç¨‹å°è£…åœ¨ `Configuration `ä¸­ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹çœ‹çœ‹ã€‚

```java
// -â˜†- Configuration
public Executor newExecutor(Transaction transaction, ExecutorType executorType) {
    executorType = executorType == null ? defaultExecutorType : executorType;
    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;
    Executor executor;
    
    // æ ¹æ® executorType åˆ›å»ºç›¸åº”çš„ Executor å®ä¾‹
    if (ExecutorType.BATCH == executorType) {...} 
    else if (ExecutorType.REUSE == executorType) {...} 
    else executor = new SimpleExecutor(this, transaction);
    if (cacheEnabled) {
        executor = new CachingExecutor(executor);
    }
    
    // æ¤å…¥æ’ä»¶
    executor = (Executor) interceptorChain.pluginAll(executor);
    return executor;
}
```

å¦‚ä¸Šï¼Œ`newExecutor ()`æ–¹æ³•åœ¨åˆ›å»ºå¥½ `Executor `å®ä¾‹åï¼Œç´§æ¥ç€é€šè¿‡æ‹¦æˆªå™¨é“¾ `InterceptorChain `ä¸º `Executor `å®ä¾‹æ¤å…¥ä»£ç†é€»è¾‘ã€‚

`InterceptorChain#pluginAll `æ–¹æ³•ä¼šè°ƒç”¨å…·ä½“æ’ä»¶çš„ `plugin `æ–¹æ³•æ¤å…¥ç›¸åº”çš„æ’ä»¶é€»è¾‘ã€‚å¦‚æœæœ‰å¤šä¸ªæ’ä»¶ï¼Œåˆ™ä¼šå¤šæ¬¡è°ƒç”¨ `plugin `æ–¹æ³•ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå±‚å±‚åµŒå¥—çš„ä»£ç†ç±»ã€‚å½¢å¦‚ä¸‹é¢ï¼š<img src="http://ahaolin-public-img.oss-cn-hangzhou.aliyuncs.com/img/202202141406007.jpeg" alt="img" style="zoom:12%;" />

> å½“ `Executor `çš„æŸä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ’ä»¶é€»è¾‘ä¼šå…ˆè¡Œæ‰§è¡Œã€‚æ‰§è¡Œé¡ºåºç”±å¤–è€Œå†…ï¼Œæ¯”å¦‚ä¸Šå›¾çš„æ‰§è¡Œé¡ºåºä¸º `plugin3 â†’ plugin2 â†’ Plugin1 â†’ Executor`ã€‚

`plugin `æ–¹æ³•æ˜¯ç”±å…·ä½“çš„æ’ä»¶ç±»å®ç°ï¼Œä¸è¿‡è¯¥æ–¹æ³•ä»£ç ä¸€èˆ¬æ¯”è¾ƒå›ºå®šï¼Œæ‰€ä»¥ä¸‹é¢æ‰¾ä¸ªç¤ºä¾‹åˆ†æä¸€ä¸‹ã€‚

```JAVA
// -â˜†- ExamplePlugin
public Object plugin(Object target) {
    return Plugin.wrap(target, this);
}

// -â˜†- Plugin
public static Object wrap(Object target, Interceptor interceptor) {
    /*
     * è·å–æ’ä»¶ç±» @Signature æ³¨è§£å†…å®¹ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„æ˜ å°„ç»“æ„ã€‚å½¢å¦‚ä¸‹é¢ï¼š
     * {
     *     Executor.class : [query, update, commit],
     *     ParameterHandler.class : [getParameterObject, setParameters]
     * }
     */
    Map<Class<?>, Set<Method>> signatureMap = getSignatureMap(interceptor);
    Class<?> type = target.getClass();
    // è·å–ç›®æ ‡ç±»å®ç°çš„æ¥å£
    Class<?>[] interfaces = getAllInterfaces(type, signatureMap);
    if (interfaces.length > 0) { 
        // é€šè¿‡ JDK åŠ¨æ€ä»£ç†ä¸ºç›®æ ‡ç±»ç”Ÿæˆä»£ç†ç±»
        return Proxy.newProxyInstance(
            type.getClassLoader(),
            interfaces,
            new Plugin(target, interceptor, signatureMap));
    }
    return target;
}
```

> **ç›®æ ‡ç±»å¿…é¡»æœ‰å®ç°çš„æ¥å£ï¼Œå¦åˆ™æ— æ³•è¿›è¡ŒjdkåŠ¨æ€ä»£ç†ï¼Œä¹Ÿå°±æ— æ³•è¿›è¡Œå¢å¼ºã€‚**

#### 6.2.3 æ‰§è¡Œæ’ä»¶é€»è¾‘

`Plugin `å®ç°äº† `InvocationHandler `æ¥å£ï¼Œå› æ­¤å®ƒçš„ `invoke() `æ–¹æ³•ä¼šæ‹¦æˆªæ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨ã€‚invoke æ–¹æ³•ä¼šå¯¹æ‰€æ‹¦æˆªçš„æ–¹æ³•è¿›è¡Œæ£€æµ‹ï¼Œä»¥å†³å®šæ˜¯å¦æ‰§è¡Œæ’ä»¶é€»è¾‘ã€‚è¯¥æ–¹æ³•çš„é€»è¾‘å¦‚ä¸‹ï¼š

```java
// -â˜†- Plugin
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
    try {
        /*
         * è·å–è¢«æ‹¦æˆªæ–¹æ³•åˆ—è¡¨ï¼Œæ¯”å¦‚ï¼š
         *    signatureMap.get(Executor.class)ï¼Œå¯èƒ½è¿”å› [query, update, commit]
         */
        Set<Method> methods = signatureMap.get(method.getDeclaringClass());
        // æ£€æµ‹æ–¹æ³•åˆ—è¡¨æ˜¯å¦åŒ…å«è¢«æ‹¦æˆªçš„æ–¹æ³•
        if (methods != null && methods.contains(method)) {
            // æ‰§è¡Œæ’ä»¶é€»è¾‘
            return interceptor.intercept(new Invocation(target, method, args));
        }
        // æ‰§è¡Œè¢«æ‹¦æˆªçš„æ–¹æ³•
        return method.invoke(target, args);
    } catch (Exception e) {
        throw ExceptionUtil.unwrapThrowable(e);
    }
}
```

`invoke() `æ–¹æ³•çš„ä»£ç æ¯”è¾ƒå°‘ï¼Œé€»è¾‘ä¸éš¾ç†è§£ã€‚é¦–å…ˆï¼ŒÂ·invoke() Â·æ–¹æ³•ä¼šæ£€æµ‹è¢«æ‹¦æˆªæ–¹æ³•æ˜¯å¦é…ç½®åœ¨æ’ä»¶çš„ `@Signature` æ³¨è§£ä¸­ï¼Œè‹¥æ˜¯ï¼Œåˆ™æ‰§è¡Œæ’ä»¶é€»è¾‘ï¼Œå¦åˆ™æ‰§è¡Œè¢«æ‹¦æˆªæ–¹æ³•ã€‚æ’ä»¶é€»è¾‘å°è£…åœ¨ `intercept `ä¸­ï¼Œè¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸º `Invocation`ã€‚`Invocation `ä¸»è¦ç”¨äºå­˜å‚¨ç›®æ ‡ç±»ï¼Œæ–¹æ³•ä»¥åŠæ–¹æ³•å‚æ•°åˆ—è¡¨ã€‚ä¸‹é¢ç®€å•çœ‹ä¸€ä¸‹è¯¥ç±»çš„å®šä¹‰ã€‚

```java
public class Invocation {

    private final Object target;
    private final Method method;
    private final Object[] args;

    public Invocation(Object target, Method method, Object[] args) {
        this.target = target;
        this.method = method;
        this.args = args;
    }

    // çœç•¥éƒ¨åˆ†ä»£ç 

    public Object proceed() throws InvocationTargetException, IllegalAccessException {
        // è°ƒç”¨è¢«æ‹¦æˆªçš„æ–¹æ³•
        return method.invoke(target, args);
    }
}
```

------

#### 6.3 å®ç°ä¸€ä¸ªåˆ†é¡µæ’ä»¶

```java
@Intercepts({
            @Signature(
                    type = Executor.class, // ç›®æ ‡ç±»
                    method = "query",   // ç›®æ ‡æ–¹æ³•
                    args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class}
            )
    })
    public class MySqlPagingPlugin implements Interceptor {

        private static final Integer MAPPED_STATEMENT_INDEX = 0;
        private static final Integer PARAMETER_INDEX = 1;
        private static final Integer ROW_BOUNDS_INDEX = 2;

        public Object intercept(Invocation invocation) throws Throwable {
            Object[] args = invocation.getArgs();
            RowBounds rb = (RowBounds) args[ROW_BOUNDS_INDEX];
            // æ— éœ€åˆ†é¡µ
            if (rb == RowBounds.DEFAULT) {
                return invocation.proceed();
            }

            // å°†åŸ RowBounds å‚æ•°è®¾ä¸º RowBounds.DEFAULTï¼Œå…³é—­ MyBatis å†…ç½®çš„åˆ†é¡µæœºåˆ¶
            args[ROW_BOUNDS_INDEX] = RowBounds.DEFAULT;

            MappedStatement ms = (MappedStatement) args[MAPPED_STATEMENT_INDEX];
            BoundSql boundSql = ms.getBoundSql(args[PARAMETER_INDEX]);

            // è·å– SQL è¯­å¥ï¼Œæ‹¼æ¥ limit è¯­å¥
            String sql = boundSql.getSql();
            String limit = String.format("LIMIT %d,%d", rb.getOffset(), rb.getLimit());
            sql = sql + " " + limit;

            // åˆ›å»ºä¸€ä¸ª StaticSqlSourceï¼Œå¹¶å°†æ‹¼æ¥å¥½çš„ sql ä¼ å…¥
            SqlSource sqlSource = new StaticSqlSource(ms.getConfiguration(), sql, boundSql.getParameterMappings());

            // é€šè¿‡åå°„è·å–å¹¶è®¾ç½® MappedStatement çš„ sqlSource å­—æ®µ
            Field field = MappedStatement.class.getDeclaredField("sqlSource");
            field.setAccessible(true);
            field.set(ms, sqlSource);

            // æ‰§è¡Œè¢«æ‹¦æˆªæ–¹æ³•
            return invocation.proceed();
        }

        public Object plugin(Object target) {
            return Plugin.wrap(target, this);
        }

        public void setProperties(Properties properties) {}
    }
```

â€‹	ä¸Šé¢çš„åˆ†é¡µæ’ä»¶é€šè¿‡ `RowBounds `å‚æ•°è·å–åˆ†é¡µä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ `limit `è¯­å¥ã€‚ä¹‹åæ‹¼æ¥ sqlï¼Œå¹¶ä½¿ç”¨è¯¥ sql ä½œä¸ºå‚æ•°åˆ›å»º StaticSqlSourceã€‚

â€‹	æœ€åé€šè¿‡åå°„æ›¿æ¢ `MappedStatement `å¯¹è±¡ä¸­çš„ `sqlSource `å­—æ®µã€‚ä»¥ä¸Šä»£ç ä¸­å‡ºç°äº†ä¸€äº›å¤§å®¶ä¸å¤ªç†Ÿæ‚‰çš„ç±»ï¼Œæ¯”å¦‚ BoundSqlï¼ŒMappedStatement ä»¥åŠ StaticSqlSourceï¼Œè¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹å§ã€‚

- `BoundSql `åŒ…å«äº†ç»è¿‡è§£æåçš„ `sql `è¯­å¥ï¼Œä»¥åŠä½¿ç”¨è€…**è¿è¡Œæ—¶ä¼ å…¥çš„å‚æ•°**ï¼Œè¿™äº›å‚æ•°æœ€ç»ˆä¼šè¢«è®¾ç½®åˆ° sql ä¸­ã€‚
- `MappedStatement `ä¸æ˜ å°„æ–‡ä»¶ä¸­çš„` <select>ï¼Œ<insert> ç­‰èŠ‚ç‚¹`å¯¹åº”ï¼ŒåŒ…å«äº†èŠ‚ç‚¹çš„é…ç½®ä¿¡æ¯ï¼Œæ¯”å¦‚ **idï¼ŒfetchSize ä»¥åŠ SqlSource**ã€‚
- `StaticSqlSource `æ˜¯ `SqlSource `å®ç°ç±»ä¹‹ä¸€ï¼ŒåŒ…å«å®Œå…¨è§£æåçš„ sql è¯­å¥ã€‚
- æ‰€è°“å®Œå…¨è§£ææ˜¯æŒ‡ sql è¯­å¥ä¸­ä¸åŒ…å« ${xxx} æˆ– #{xxx} ç­‰å ä½ç¬¦ï¼Œä»¥åŠå…¶ä»–ä¸€äº›æœªè§£æçš„åŠ¨æ€èŠ‚ç‚¹ï¼Œæ¯”å¦‚ `<if>ï¼Œ<where> `ç­‰ã€‚

æ¥ä¸‹é‡Œï¼Œå†™ç‚¹æµ‹è¯•ä»£ç éªŒè¯ä¸€ä¸‹æ’ä»¶æ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ Dao æ¥å£ä¸æ˜ å°„æ–‡ä»¶çš„å®šä¹‰ï¼š

```java
public interface StudentDao {
    List<Student> findByPaging( @Param("id")Integer id, RowBounds rb);
}
```

```xml
<mapper namespace="xyz.coolblog.dao6.StudentDao">
    <select id="findByPaging" resultType="xyz.coolblog.model5.Student">
        SELECT `id`, `name`, `age` FROM  student WHERE id > #{id}
    </select>
</mapper>
```

```java
public class PluginTest {

    private SqlSessionFactory sqlSessionFactory;
    
    @Before
    public void prepare() throws IOException {
        String resource = "mybatis-plugin-config.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        inputStream.close();
    }

    @Test
    public void testPlugin() {
        SqlSession session = sqlSessionFactory.openSession();
        try {
            StudentDao studentDao = session.getMapper(StudentDao.class);
            studentDao.findByPaging(1, new RowBounds(20, 10));
        } finally {
            session.close();
        }
    }
}
```

<img src="http://ahaolin-public-img.oss-cn-hangzhou.aliyuncs.com/img/202202141426260.jpeg" alt="img" style="zoom: 33%;" />

åœ¨ä¸Šé¢çš„è¾“å‡ºä¸­ï¼ŒSQL è¯­å¥ä¸­åŒ…å«äº† LIMIT å­—æ ·ï¼Œè¿™è¯´æ˜æ’ä»¶ç”Ÿæ•ˆäº†ã€‚



------



> 1. [è§£æxmlé…ç½®](#6.1.1 æ’ä»¶é…ç½®)ï¼Œè°ƒç”¨**`Interceptor#setProperties`**,æ·»åŠ æ‰€æœ‰`Interceptor`åˆ°`Configuration.interceptorChain `ä¸­ã€‚
> 2. [ç”Ÿæˆä»£ç†å¯¹è±¡](#6.2 æ¤å…¥æ’ä»¶é€»è¾‘)ã€‚è°ƒç”¨**`Interceptor#plugin`**ï¼ˆå®é™…ä¸Šå°±æ˜¯`Plugin#wrap`ï¼‰, é€šè¿‡**jdkåŠ¨æ€ä»£ç†**è·å¾—`target`çš„ä»£ç†å¯¹è±¡ï¼ˆ`target`å¿…é¡»å®ç°äº†æ¥å£ï¼‰ã€‚
> 3. [è°ƒç”¨æ–¹æ³•](#6.2.3 æ‰§è¡Œæ’ä»¶é€»è¾‘)ã€‚æ ¹æ®æ’ä»¶æ³¨è§£ï¼Œåˆ¤æ–­è¯¥å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•æ˜¯å¦æ˜¯æ‹¦æˆªçš„æ–¹æ³•ï¼Œå¦‚æœæ˜¯ï¼Œæ‰§è¡Œè°ƒç”¨**`Interceptor#intercept`**ã€‚
>
> - **`InterceptorChain.pluginAll()`æ–¹æ³•**ï¼šè¯¥æ–¹æ³•åœ¨åˆ›å»ºä¸Šè¿°4ä¸ªæ¥å£å¯¹è±¡æ—¶è°ƒç”¨ï¼Œå…¶å«ä¹‰ä¸ºç»™è¿™äº›æ¥å£å¯¹è±¡æ³¨å†Œæ‹¦æˆªå™¨åŠŸèƒ½ï¼Œæ³¨æ„æ˜¯**`æ³¨å†Œ`**ï¼Œè€Œä¸æ˜¯æ‰§è¡Œæ‹¦æˆªã€‚
> - **æ‹¦æˆªå™¨æ‰§è¡Œæ—¶æœº**ï¼š`plugin()`æ–¹æ³•æ³¨å†Œæ‹¦æˆªå™¨åï¼Œé‚£ä¹ˆï¼Œåœ¨æ‰§è¡Œä¸Šè¿°4ä¸ªæ¥å£å¯¹è±¡å†…çš„å…·ä½“æ–¹æ³•æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘æ‹¦æˆªå™¨çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ’ä»¶çš„æ‰§è¡Œã€‚

## 7. **PageHelper

[Mybatis-PageHelper](https://github.com/pagehelper/Mybatis-PageHelper) ï¼ŒåŸºäº MyBatis æ’ä»¶ä½“ç³»ï¼Œå®ç°äº†**åˆ†é¡µ**åŠŸèƒ½ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹å®ƒçš„æºç ã€‚è‰¿è‰¿æš‚æ—¶ä¸æ˜¯ç‰¹åˆ«æ„Ÿå…´è¶£ï¼Œå› ä¸ºï¼š

1. å›¢é˜Ÿç›®å‰ä¸»è¦ä»¥æ‰‹å†™ SQL ä¸ºä¸»ï¼Œæˆ–è€…è‡ªåŠ¨ç”Ÿæˆ SQL ä¸ºè¾…ã€‚
2. [MyBatis-Plus](https://github.com/baomidou/mybatis-plus) ä¹Ÿæä¾›äº†åˆ†é¡µæ’ä»¶ï¼Œå¹¶ä¸”æ®è‰¿è‰¿äº†è§£åˆ°ï¼Œå¯èƒ½æ›´åŠ å¹¿æ³›ã€‚å®ƒçš„åˆ†é¡µæ’ä»¶çš„æ‹¦æˆªå™¨æ˜¯ `com.baomidou.mybatisplus.plugins.PaginationInterceptor` ï¼Œå…·ä½“å¯å‚è§æ–‡æ¡£ [ã€ŠMyBatis-Plus æ–‡æ¡£ â€”â€” åˆ†é¡µæ’ä»¶ã€‹](https://baomidou.com/pages/2976a3/#innerinterceptor) ã€‚

å½“ç„¶ï¼Œè€ƒè™‘åˆ°èƒ–å‹å¯èƒ½æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œè‰¿è‰¿è¿˜æ˜¯ç¿»äº†ç¿»ç›®å‰ç½‘ç»œä¸Šçš„æ–‡ç« ï¼Œç›®å‰å†™çš„æ¯”è¾ƒå¥½çš„æ˜¯ï¼š

- ç¥–å¤§ä¿Š [ã€ŠMybatis3.4.xæŠ€æœ¯å†…å¹•ï¼ˆäºŒåï¼‰ï¼šPageHelperåˆ†é¡µæ’ä»¶æºç åŠåŸç†å‰–æã€‹](https://my.oschina.net/zudajun/blog/745232)
  - å› ä¸ºå†™çš„æ¯”è¾ƒæ—©ï¼Œæ‰€ä»¥å¯¹åº”çš„ [Mybatis-PageHelper](https://github.com/pagehelper/Mybatis-PageHelper) çš„ä»£ç æ¯”è¾ƒæ—©ï¼Œæ‰€ä»¥å’Œç›®å‰çš„ä»£ç ï¼Œå·²ç»å¯¹åº”ä¸ä¸Šäº†ã€‚
- ã€**ç›¸å¯¹æ¨è**ã€‘ä¸€ç›´ä¸æ‡‚ [ã€Šã€Mybatisæºç åˆ†æã€‘12-æ’ä»¶PageHelperæœºåˆ¶ã€‹](https://blog.csdn.net/shenchaohao12321/article/details/80168655)

## 666. å½©è›‹

åœ¨åœ°é“ä¸Šï¼Œæ’¸å®Œäº†è¿™ç¯‡åšå®¢ï¼Œå°æ–‡ä¸€ç¯‡ã€‚åç»­ï¼Œæˆ‘ä»¬ä¼šæ‰¾ä¸€äº› MyBatis çš„æ’ä»¶ï¼Œè¯¦ç»†è§£æã€‚å¦å¤–ï¼ŒMyBatis å¹¶æœªæä¾›è‡ªå¸¦çš„æ’ä»¶å®ç°ã€‚

å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- `ç¥–å¤§ä¿Š` [ã€ŠMybatis3.4.xæŠ€æœ¯å†…å¹•ï¼ˆåä¹ï¼‰ï¼šMybatisä¹‹pluginæ’ä»¶è®¾è®¡åŸç†ã€‹](https://my.oschina.net/zudajun/blog/738973)
- `ç”°å°æ³¢` [ã€ŠMyBatis æºç åˆ†æ - æ’ä»¶æœºåˆ¶ã€‹](https://www.tianxiaobo.com/2018/08/26/MyBatis-æºç åˆ†æ-æ’ä»¶æœºåˆ¶/)
- å¾éƒ¡æ˜ [ã€ŠMyBatis æŠ€æœ¯å†…å¹•ã€‹](https://item.jd.com/12125531.html) çš„ [ã€Œ4.1 æ’ä»¶æ¨¡å—ã€](http://svip.iocoder.cn/MyBatis/plugin-1/#) å°èŠ‚